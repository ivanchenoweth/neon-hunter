#!/bin/bash

# ==============================================================================
# gh-reset-tags.sh
# Script para limpiar tags viejos de Git (local y remoto)
# Elimina TODOS los tags que comienzan con 'v' (v1.0.0, v1.1.0, etc.)
# ==============================================================================

set -e

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ         ๐งน CLEANUP: Reset Tags                                    โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 1: Listar y confirmar los tags viejos a eliminar
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ Tags actuales en Git:"
echo ""
git tag --list 'v*' --sort=-version:refname || echo "   (Sin tags)"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 2: Confirmar que el usuario desea continuar
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โ๏ธ  ADVERTENCIA: Este script eliminarรก TODOS los tags viejos."
echo "   Esta acciรณn NO se puede deshacer."
echo ""
read -p "ยฟDeseas continuar? (sรญ/no): " confirm

if [[ "$confirm" != "sรญ" && "$confirm" != "si" && "$confirm" != "yes" && "$confirm" != "y" ]]; then
    echo "โ Operaciรณn cancelada."
    exit 0
fi

echo ""
echo "๐๏ธ  Eliminando tags viejos..."
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 3: Eliminar tags viejos localmente
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Generar lista dinรกmica de tags a eliminar
# Busca todos los tags que comienzan con 'v' (cualquier formato SemVer)
OLD_TAGS=$(git tag --list 'v*' --sort=-version:refname || true)

if [ -z "$OLD_TAGS" ]; then
    echo "โน๏ธ  No se encontraron tags para eliminar"
else
    echo "๐ Eliminando localmente:"
    echo "$OLD_TAGS" | while read tag; do
        echo "   - Eliminando $tag (local)"
        git tag -d "$tag" 2>/dev/null || echo "   โ๏ธ  No se pudo eliminar $tag localmente"
    done
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 4: Eliminar tags viejos del remoto (GitHub)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ -z "$OLD_TAGS" ]; then
    echo "โน๏ธ  No hay tags remotos para eliminar"
else
    echo "โ๏ธ  Eliminando del remoto (origin):"
    echo "$OLD_TAGS" | while read tag; do
        echo "   - Eliminando $tag (remoto)"
        git push --delete origin "$tag" 2>/dev/null || git push origin ":$tag" 2>/dev/null || echo "   โ๏ธ  No se pudo eliminar $tag del remoto"
    done
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# RESUMEN FINAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                    โ TAGS RESET COMPLETADO                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ Cambios realizados:"
echo "   โ Tags viejos (v*.0) eliminados localmente"
echo "   โ Tags viejos eliminados de GitHub (origin)"
echo ""
echo "๐ Verificaciรณn:"
echo "   git tag --list                  # Ver tags (debe estar vacรญo)"
echo ""
